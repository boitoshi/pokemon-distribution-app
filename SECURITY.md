# セキュリティレポート

最終更新: 2026-02-06

## 実施したセキュリティチェック

### 1. XSS（クロスサイトスクリプティング）対策 ✅

#### 実施した対策
- **HTMLエスケープ関数の実装**: `escapeHtml()` 関数を追加し、すべてのユーザー入力とデータベースからのデータをエスケープ
- **textContent優先**: 可能な限り `innerHTML` の代わりに `textContent` を使用
- **比較モーダルの修正**: すべてのポケモンデータ（名前、技、リボン、親名など）をエスケープして埋め込み

#### 修正した箇所
- `src/pages/index.astro`:
  - 行107-112: `escapeHtml()` 関数の実装
  - 行728: ポケモン名のエスケープ
  - 行785: ボール名の表示を `textContent` に変更
  - 行1274-1312: 比較モーダルのすべてのフィールドをエスケープ

#### リスク評価
- **修正前**: 高リスク - pokemon.jsonが改ざんされた場合、任意のJavaScriptコードが実行可能
- **修正後**: 低リスク - すべてのデータがエスケープされるため、HTMLタグやスクリプトは無害化される

### 2. JSON.parse セキュリティ ✅

#### 実施した対策
- **エラーハンドリングの追加**: localStorageからのデータ読み込み時に try-catch を追加
- **データ検証**: pokemon.jsonの読み込み時に配列であることを確認

#### 修正した箇所
- `src/pages/index.astro`:
  - 行120-127: `getFavorites()` に try-catch 追加
  - 行147-154: `getNotes()` に try-catch 追加
  - 行263-268: `loadData()` でデータ検証追加

#### リスク評価
- **修正前**: 中リスク - 不正なJSONでアプリケーションがクラッシュする可能性
- **修正後**: 低リスク - エラーが発生してもグレースフルに処理

### 3. CSVインジェクション対策 ✅

#### 実施した対策
- **CSVサニタイズ関数の実装**: セルが `=+-@` で始まる場合、シングルクォートを追加
- **ダブルクォートのエスケープ**: すべてのCSV値を適切にエスケープ

#### 修正した箇所
- `src/pages/index.astro`:
  - 行1099-1105: `sanitizeCsvValue()` 関数の実装
  - 行1107-1129: CSVエクスポート時に全フィールドをサニタイズ

#### リスク評価
- **修正前**: 中リスク - Excelで開いた際に数式が実行される可能性
- **修正後**: 低リスク - 数式として認識されないよう安全化

### 4. localStorage セキュリティ

#### 現状
- お気に入りとメモをlocalStorageに保存
- XSS攻撃が成功すれば、localStorageのデータは盗まれる可能性がある

#### リスク評価
- **リスクレベル**: 低
- **理由**:
  - 保存されているのは個人的なメモのみ（パスワードやトークンなし）
  - XSS対策を実施済みなので、攻撃の可能性は低い
  - データは他のユーザーには影響しない（ローカルのみ）

### 5. データソースのセキュリティ

#### 現状
- `pokemon.json` は静的ファイルとして配信
- Googleスプレッドシートから手動でエクスポート
- ユーザーが直接編集することはできない

#### リスク評価
- **リスクレベル**: 低
- **理由**:
  - 管理者のみがデータを更新可能
  - ユーザー入力は検索クエリとメモのみ（データベースには保存されない）

## 追加推奨事項

### 1. Content Security Policy (CSP) の設定 🔶

現在未実装。以下のCSPヘッダーを設定することを推奨：

```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               script-src 'self' 'unsafe-inline';
               img-src 'self' https://raw.githubusercontent.com;
               style-src 'self' 'unsafe-inline';">
```

**実装方法**: `src/layouts/Layout.astro` の `<head>` タグ内に追加

### 2. Subresource Integrity (SRI) 🔶

外部リソース（PokeAPI画像）にSRIを適用することを検討。ただし、動的に生成される画像には適用困難。

### 3. HTTPS の強制 ✅

本番環境 (pokebros.net) はHTTPSで配信されているため、問題なし。

### 4. レート制限 🔶

現在未実装。将来的にバックエンドAPIを追加する場合は、レート制限を実装すること。

## 脆弱性スキャン結果

### テスト項目

- [x] XSS (Reflected)
- [x] XSS (Stored) - N/A (ユーザー入力を保存しない)
- [x] SQL Injection - N/A (データベースなし)
- [x] CSRF - N/A (状態変更APIなし)
- [x] Click Jacking - 低リスク（iframe埋め込みのリスクは低い）
- [x] Open Redirect - N/A（外部リダイレクトなし）
- [x] File Upload - N/A（ファイルアップロード機能なし）
- [x] SSRF - N/A（サーバーサイドリクエストなし）

## 結論

**総合評価**: ✅ **公開可能**

このプロジェクトは、以下の理由により**安全に公開できる**と判断します：

1. ✅ 主要なXSS脆弱性を修正済み
2. ✅ ユーザー入力はローカルに保存されるのみで、他のユーザーに影響しない
3. ✅ データソースは管理者のみが編集可能
4. ✅ 機密情報（パスワード、トークンなど）を扱わない
5. ✅ 静的サイトのため、サーバーサイドの脆弱性がない

### 公開前の最終チェックリスト

- [ ] `pokemon.json` に機密情報が含まれていないことを確認
- [ ] HTTPS が有効になっていることを確認
- [ ] エラーメッセージに機密情報（パス、バージョン情報など）が含まれていないことを確認
- [ ] 本番環境で動作テストを実施

## 継続的なセキュリティ対策

1. **定期的な依存関係の更新**: `npm audit` を定期的に実行
2. **セキュリティヘッダーの追加**: CSP、X-Frame-Options、X-Content-Type-Options など
3. **ユーザーからの脆弱性報告の受け入れ**: GitHubのIssueで受け付け

## 報告された脆弱性

現在、報告された脆弱性はありません。

---

セキュリティに関する質問や報告は、GitHubのIssueまでお願いします。
