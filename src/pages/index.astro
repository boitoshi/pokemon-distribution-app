---
import Layout from '../layouts/Layout.astro';
import SearchBox from '../components/SearchBox.astro';
import PokemonCard from '../components/PokemonCard.astro';

const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹">
    <header>
        <h1>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
        <p>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢ã§ãã¾ã™</p>
    </header>

    <SearchBox />

    <div class="stats" id="stats" style="display: none;">
        <div class="stats-left">
            <span id="resultCount"></span>
        </div>
        <div class="quick-filters" id="quickFilters">
            <button class="quick-filter-btn" data-filter="shiny">
                <span class="quick-icon">âœ¨</span>
                <span class="quick-text">è‰²é•ã„</span>
            </button>
            <button class="quick-filter-btn" data-filter="gigantamax">
                <span class="quick-icon">ğŸ”·</span>
                <span class="quick-text">ã‚­ãƒ§ãƒ€ã‚¤</span>
            </button>
            <button class="quick-filter-btn" data-filter="alpha">
                <span class="quick-icon">ğŸ‘‘</span>
                <span class="quick-text">ã‚ªãƒ¤ãƒ–ãƒ³</span>
            </button>
            <button class="quick-filter-btn" data-filter="moves">
                <span class="quick-icon">ğŸ¯</span>
                <span class="quick-text">æŠ€</span>
            </button>
            <button class="quick-filter-btn" data-filter="item">
                <span class="quick-icon">ğŸ</span>
                <span class="quick-text">æŒã¡ç‰©</span>
            </button>
        </div>
    </div>

    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="results" id="results"></div>

    <!-- ä¸€ç•ªä¸Šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="scrollToTop" class="scroll-to-top" aria-label="ä¸€ç•ªä¸Šã«æˆ»ã‚‹">â†‘</button>

    <PokemonCard />
</Layout>

<script define:vars={{ baseUrl }}>
    let allData = [];
    const JSON_URL = `${baseUrl.endsWith('/') ? baseUrl : baseUrl + '/'}pokemon.json`;

    // ãƒã‚±ãƒ¢ãƒ³ç”»åƒURLç”Ÿæˆé–¢æ•°ï¼ˆå°†æ¥çš„ã«è‡ªå‰ç”»åƒã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼‰
    function getPokemonImageUrl(dexNo) {
        // æ¤œè¨¼ç”¨: PokeAPIå…¬å¼ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${dexNo}.png`;

        // æœ¬ç•ªç”¨ï¼ˆè‡ªå‰ç”»åƒã‚’ä½¿ã†å ´åˆã¯ã“ã¡ã‚‰ã«åˆ‡ã‚Šæ›¿ãˆï¼‰:
        // return `${baseUrl}images/pokemon/${dexNo}.png`;
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    function applyUrlParameters() {
        const params = new URLSearchParams(window.location.search);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const filters = [
            { param: 'shiny', id: 'filterShiny' },
            { param: 'gigantamax', id: 'filterGigantamax' },
            { param: 'alpha', id: 'filterAlpha' },
            { param: 'moves', id: 'filterSpecialMoves' },
            { param: 'item', id: 'filterHeldItem' }
        ];

        let hasFilters = false;

        filters.forEach(({ param, id }) => {
            if (params.get(param) === '1') {
                hasFilters = true;
                const el = document.getElementById(id);
                if (el) el.checked = true;
            }
        });

        // ãƒªãƒœãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const ribbon = params.get('ribbon');
        if (ribbon) {
            hasFilters = true;
            const ribbonSelect = document.getElementById('filterRibbon');
            if (ribbonSelect) ribbonSelect.value = ribbon;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãŸã‚‰è‡ªå‹•æ¤œç´¢
        if (hasFilters) {
            searchPokemon();
        }
    }

    // Load data on page load
    async function loadData() {
        try {
            const response = await fetch(JSON_URL);
            const data = await response.json();
            allData = data;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats').style.display = 'flex';

            // Populate filter dropdowns
            populateFilters();

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é©ç”¨
            applyUrlParameters();

            // Display all results (URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚Œã¦ã„ãªã‘ã‚Œã°å…¨ä»¶è¡¨ç¤º)
            const params = new URLSearchParams(window.location.search);
            if (![...params.keys()].some(key => ['shiny', 'gigantamax', 'alpha', 'moves', 'ribbon', 'item'].includes(key))) {
                displayResults(allData);
            }
        } catch (error) {
            console.error('Data loading error:', error);
            document.getElementById('loading').innerHTML =
                '<div style="background: white; padding: 30px; border-radius: 8px; color: #d32f2f;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
        }
    }

    // Populate filter dropdowns from data
    function populateFilters() {
        const games = [...new Set(allData.map(p => p.game))].sort();
        const methods = [...new Set(allData.map(p => p.distributionMethod))].sort();

        const gameSelect = document.getElementById('filterGame');
        games.forEach(game => {
            const option = document.createElement('option');
            option.value = game;
            option.textContent = game;
            gameSelect.appendChild(option);
        });

        const methodSelect = document.getElementById('filterMethod');
        methods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            methodSelect.appendChild(option);
        });

        // ãƒªãƒœãƒ³ã®ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
        const ribbonSet = new Set();
        allData.forEach(p => {
            const ribbons = p.ribbons && Array.isArray(p.ribbons)
                ? p.ribbons.filter(r => r && r !== '')
                : [p.ribbon1, p.ribbon2, p.ribbon3].filter(r => r && r !== '');
            ribbons.forEach(r => ribbonSet.add(r));
        });
        const ribbons = [...ribbonSet].sort();

        const ribbonSelect = document.getElementById('filterRibbon');
        ribbons.forEach(ribbon => {
            const option = document.createElement('option');
            option.value = ribbon;
            option.textContent = `ğŸ€ ${ribbon}`; // ãƒªãƒœãƒ³ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 
            ribbonSelect.appendChild(option);
        });
    }

    // æ¤œç´¢çµæœã‚’ä¿å­˜ï¼ˆç´ æ—©ã„çµã‚Šè¾¼ã¿ç”¨ï¼‰
    let searchResults = [];

    // Search function
    function searchPokemon() {
        const searchName = document.getElementById('searchName').value.toLowerCase();
        const filterGeneration = document.getElementById('filterGeneration').value;
        const filterGame = document.getElementById('filterGame').value;
        const filterMethod = document.getElementById('filterMethod').value;
        const filterShiny = document.getElementById('filterShiny')?.checked;
        const filterGigantamax = document.getElementById('filterGigantamax')?.checked;
        const filterAlpha = document.getElementById('filterAlpha')?.checked;
        const filterSpecialMoves = document.getElementById('filterSpecialMoves')?.checked;
        const filterHeldItem = document.getElementById('filterHeldItem')?.checked;
        const filterRibbon = document.getElementById('filterRibbon')?.value;

        let filtered = allData;

        // Filter by Pokemon name or event name
        if (searchName) {
            filtered = filtered.filter(p =>
                p.pokemonName.toLowerCase().includes(searchName) ||
                p.eventName.toLowerCase().includes(searchName)
            );
        }

        // Filter by generation
        if (filterGeneration) {
            filtered = filtered.filter(p => p.generation === parseInt(filterGeneration));
        }

        // Filter by game
        if (filterGame) {
            filtered = filtered.filter(p => p.game === filterGame);
        }

        // Filter by distribution method
        if (filterMethod) {
            filtered = filtered.filter(p => p.distributionMethod === filterMethod);
        }

        // Filter by shiny
        if (filterShiny) {
            filtered = filtered.filter(p => p.shiny && p.shiny !== '');
        }

        // Filter by Gigantamax
        if (filterGigantamax) {
            filtered = filtered.filter(p => p.gigantamax && p.gigantamax !== '');
        }

        // Filter by Alpha (ã‚ªãƒ¤ãƒ–ãƒ³)
        if (filterAlpha) {
            filtered = filtered.filter(p => p.isAlpha && p.isAlpha !== '');
        }

        // Filter by special moves (æŠ€ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹)
        if (filterSpecialMoves) {
            filtered = filtered.filter(p => {
                const moves = p.moves && Array.isArray(p.moves)
                    ? p.moves.filter(m => m && m !== '')
                    : [p.move1, p.move2, p.move3, p.move4].filter(m => m && m !== '');
                return moves.length > 0;
            });
        }

        // Filter by specific ribbon (ç‰¹å®šã®ãƒªãƒœãƒ³)
        if (filterRibbon) {
            filtered = filtered.filter(p => {
                const ribbons = p.ribbons && Array.isArray(p.ribbons)
                    ? p.ribbons.filter(r => r && r !== '')
                    : [p.ribbon1, p.ribbon2, p.ribbon3].filter(r => r && r !== '');
                return ribbons.includes(filterRibbon);
            });
        }

        // Filter by held item (æŒã¡ç‰©ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹)
        if (filterHeldItem) {
            filtered = filtered.filter(p => p.heldItem && p.heldItem !== '');
        }

        // æ¤œç´¢çµæœã‚’ä¿å­˜
        searchResults = filtered;

        // ç´ æ—©ã„çµã‚Šè¾¼ã¿ã‚’ãƒªã‚»ãƒƒãƒˆ
        resetQuickFilters();

        displayResults(filtered);
    }

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿æ©Ÿèƒ½
    function applyQuickFilter(filterType) {
        let filtered = searchResults;

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç´ æ—©ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å–å¾—
        const activeFilters = [...document.querySelectorAll('.quick-filter-btn.active')]
            .map(btn => btn.dataset.filter);

        // å„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        activeFilters.forEach(filter => {
            switch(filter) {
                case 'shiny':
                    filtered = filtered.filter(p => p.shiny && p.shiny !== '');
                    break;
                case 'gigantamax':
                    filtered = filtered.filter(p => p.gigantamax && p.gigantamax !== '');
                    break;
                case 'alpha':
                    filtered = filtered.filter(p => p.isAlpha && p.isAlpha !== '');
                    break;
                case 'moves':
                    filtered = filtered.filter(p => {
                        const moves = p.moves && Array.isArray(p.moves)
                            ? p.moves.filter(m => m && m !== '')
                            : [p.move1, p.move2, p.move3, p.move4].filter(m => m && m !== '');
                        return moves.length > 0;
                    });
                    break;
                case 'item':
                    filtered = filtered.filter(p => p.heldItem && p.heldItem !== '');
                    break;
            }
        });

        displayResults(filtered);
    }

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetQuickFilters() {
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    // ãƒ¢ãƒã‚¤ãƒ«ã§çµæœã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®ã¿ï¼‰
    function scrollToResults() {
        if (window.innerWidth <= 768) {
            const resultsEl = document.getElementById('results');
            // å°‘ã—é…å»¶ã•ã›ã¦DOMæ›´æ–°å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    }

    // Check if distribution is active
    function isDistributionActive(endDate) {
        if (!endDate) return true; // No end date means ongoing
        const now = new Date();
        const end = new Date(endDate);
        return now <= end;
    }

    // Create distribution status badge
    function createStatusBadge(endDate) {
        const isActive = isDistributionActive(endDate);
        const statusClass = isActive ? 'status-active' : 'status-ended';
        const statusText = isActive ? 'é…ä¿¡ä¸­' : 'çµ‚äº†';
        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
    }

    // Game type detection helpers
    function isSwSh(game) {
        return game && (game.includes('ã‚½ãƒ¼ãƒ‰') || game.includes('ã‚·ãƒ¼ãƒ«ãƒ‰'));
    }

    function isSV(game) {
        return game && (game.includes('ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ') || game.includes('ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ'));
    }

    function isLegendsGame(game) {
        return game && (game.includes('ã‚¢ãƒ«ã‚»ã‚¦ã‚¹') || game.includes('Z-A'));
    }

    // Create a Pokemon card element
    function createPokemonCard(pokemon) {
        const template = document.getElementById('pokemon-card-template');
        const card = template.content.cloneNode(true);
        const cardEl = card.querySelector('.pokemon-card');

        // Store pokemon data for modal
        cardEl.dataset.pokemonData = JSON.stringify(pokemon);

        // ãƒã‚±ãƒ¢ãƒ³ç”»åƒã®è¨­å®š
        const imgEl = cardEl.querySelector('.pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ï¼ˆç”»åƒã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name
        cardEl.querySelector('.pokemon-name').textContent = pokemon.pokemonName;

        // Dex Number (No.025 format)
        cardEl.querySelector('.dex-number').textContent = `No.${String(pokemon.dexNo).padStart(3, '0')}`;

        let badgesHtml = '';
        if (pokemon.shiny && pokemon.shiny !== '') {
            badgesHtml += '<span class="icon-badge" title="è‰²é•ã„">âœ¨</span>';
        }
        // ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹ï¼ˆã‚½ãƒ¼ãƒ‰/ã‚·ãƒ¼ãƒ«ãƒ‰ã®ã¿ï¼‰
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="icon-badge" title="ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹">ğŸ”·</span>';
        }
        // ãƒ†ãƒ©ã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ/ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆã®ã¿ï¼‰
        if (pokemon.teraType && pokemon.teraType !== '' && isSV(pokemon.game)) {
            badgesHtml += `<span class="tera-type-badge" title="ãƒ†ãƒ©ã‚¹ã‚¿ã‚¤ãƒ—: ${pokemon.teraType}">${pokemon.teraType}</span>`;
        }
        // ã‚ªãƒ¤ãƒ–ãƒ³ï¼ˆã‚¢ãƒ«ã‚»ã‚¦ã‚¹/Z-Aã®ã¿ï¼‰
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="icon-badge" title="ã‚ªãƒ¤ãƒ–ãƒ³">ğŸ‘‘</span>';
        }
        cardEl.querySelector('.badges').innerHTML = badgesHtml;

        // Generation badge
        const genBadge = cardEl.querySelector('.generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        cardEl.querySelector('.event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        cardEl.querySelector('.distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        // Distribution status badge
        cardEl.querySelector('.distribution-status').innerHTML = createStatusBadge(pokemon.endDate);

        // Distribution method and location
        cardEl.querySelector('.distribution-method').textContent = pokemon.distributionMethod;
        cardEl.querySelector('.distribution-location').textContent = pokemon.distributionLocation;

        // Ribbons (é…åˆ—å½¢å¼ã¾ãŸã¯ã‚«ãƒ©ãƒ å½¢å¼ã«å¯¾å¿œ)
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsRow = cardEl.querySelector('.ribbons-row');
            ribbonsRow.style.display = 'flex';
            cardEl.querySelector('.ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        return card;
    }

    // Show modal with Pokemon details
    function showDetailModal(pokemon) {
        const template = document.getElementById('pokemon-modal-template');
        const modal = template.content.cloneNode(true);
        const modalEl = modal.querySelector('.modal-overlay');

        // Pokemon image
        const imgEl = modalEl.querySelector('.modal-pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name with shiny indicator
        const pokemonNameEl = modalEl.querySelector('.modal-pokemon-name');
        pokemonNameEl.textContent = pokemon.pokemonName;
        if (pokemon.shiny && pokemon.shiny !== '') {
            pokemonNameEl.innerHTML = pokemon.pokemonName + ' <span class="modal-shiny-indicator" title="è‰²é•ã„">âœ¨</span>';
        }

        // Dex Number (large display in modal)
        modalEl.querySelector('.modal-dex-number').textContent = `No.${String(pokemon.dexNo).padStart(3, '0')}`;

        // Badges (icon style for mobile, text for PC)
        let badgesHtml = '';
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="icon-badge mobile-only" title="ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹">ğŸ”·</span>';
            badgesHtml += '<span class="text-badge pc-only">ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹å¯</span>';
        }
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="icon-badge mobile-only" title="ã‚ªãƒ¤ãƒ–ãƒ³">ğŸ‘‘</span>';
            badgesHtml += '<span class="text-badge pc-only">ã‚ªãƒ¤ãƒ–ãƒ³</span>';
        }
        modalEl.querySelector('.modal-badges').innerHTML = badgesHtml;

        // Generation badge
        const genBadge = modalEl.querySelector('.modal-generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        modalEl.querySelector('.modal-event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        modalEl.querySelector('.modal-distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        // Distribution status badge in modal
        modalEl.querySelector('.modal-distribution-status').innerHTML = createStatusBadge(pokemon.endDate);

        modalEl.querySelector('.modal-distribution-method').textContent = pokemon.distributionMethod;
        modalEl.querySelector('.modal-distribution-location').textContent = pokemon.distributionLocation;
        modalEl.querySelector('.modal-game').textContent = pokemon.game;

        // Stats
        modalEl.querySelector('.modal-level').textContent = pokemon.level || '?';
        modalEl.querySelector('.modal-ability').textContent = pokemon.ability || '?';

        if (pokemon.nature) {
            const natureRow = modalEl.querySelector('.modal-nature-row');
            natureRow.style.display = 'flex';
            modalEl.querySelector('.modal-nature').textContent = pokemon.nature;
        }

        // Ball info (with icon)
        const ballStatus = modalEl.querySelector('.modal-ball-status');
        if (pokemon.ball) {
            ballStatus.innerHTML = `âšª ${pokemon.ball}`;
        } else {
            ballStatus.textContent = '?';
        }

        // Tera Type (only for Scarlet/Violet)
        if (pokemon.teraType && pokemon.teraType !== '' && isSV(pokemon.game)) {
            const teraTypeRow = modalEl.querySelector('.modal-tera-type-row');
            teraTypeRow.style.display = 'flex';
            modalEl.querySelector('.modal-tera-type').textContent = pokemon.teraType;
        }

        // Held item (optional)
        if (pokemon.heldItem && pokemon.heldItem !== '') {
            const itemRow = modalEl.querySelector('.modal-item-row');
            itemRow.style.display = 'flex';
            modalEl.querySelector('.modal-item-tag').textContent = pokemon.heldItem;
        }

        // Moves (displayed as vertical list)
        const moves = pokemon.moves && Array.isArray(pokemon.moves)
            ? pokemon.moves.filter(m => m && m !== '')
            : [pokemon.move1, pokemon.move2, pokemon.move3, pokemon.move4].filter(m => m && m !== '');
        if (moves.length > 0) {
            const movesSection = modalEl.querySelector('.modal-moves-section');
            movesSection.style.display = 'block';
            modalEl.querySelector('.modal-moves').innerHTML = moves.map(move =>
                `<div class="move-item">${move}</div>`
            ).join('');
        }

        // Trainer info - OT with multi-language support
        const otEl = modalEl.querySelector('.modal-ot');
        if (pokemon.ot) {
            if (typeof pokemon.ot === 'object') {
                // Multi-language OT object (e.g., {ja: "ã‚µãƒˆã‚·", en: "Ash"})
                const otParts = [];
                if (pokemon.ot.ja) otParts.push(`æ—¥: ${pokemon.ot.ja}`);
                if (pokemon.ot.en) otParts.push(`è‹±: ${pokemon.ot.en}`);
                if (pokemon.ot.ko) otParts.push(`éŸ“: ${pokemon.ot.ko}`);
                if (pokemon.ot.zh) otParts.push(`ä¸­: ${pokemon.ot.zh}`);
                otEl.textContent = otParts.join(' / ') || '?';
            } else {
                // String OT
                otEl.textContent = pokemon.ot;
            }
        } else {
            otEl.textContent = '?';
        }

        if (pokemon.trainerId) {
            const trainerIdRow = modalEl.querySelector('.modal-trainer-id-row');
            trainerIdRow.style.display = 'flex';
            modalEl.querySelector('.modal-trainer-id').textContent = pokemon.trainerId;
        }

        // Ribbons
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsSection = modalEl.querySelector('.modal-ribbons-section');
            ribbonsSection.style.display = 'block';
            modalEl.querySelector('.modal-ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        // Notes
        if (pokemon.notes && pokemon.notes !== '') {
            const notesSection = modalEl.querySelector('.modal-notes-section');
            notesSection.style.display = 'block';
            modalEl.querySelector('.modal-notes').textContent = pokemon.notes;
        }

        // Post URL
        if (pokemon.postUrl && pokemon.postUrl !== '') {
            const postUrlRow = modalEl.querySelector('.modal-post-url-row');
            postUrlRow.style.display = 'flex';
            const postUrlLink = modalEl.querySelector('.modal-post-url-link');
            postUrlLink.href = pokemon.postUrl;
        }

        // Add to body
        document.body.appendChild(modal);

        // Close modal on overlay click or close buttons
        const overlay = document.querySelector('.modal-overlay');
        const closeBtn = overlay.querySelector('.modal-close');
        const bottomCloseBtn = overlay.querySelector('.modal-bottom-close');

        const closeModal = () => {
            overlay.remove();
        };

        closeBtn.addEventListener('click', closeModal);
        bottomCloseBtn.addEventListener('click', closeModal);

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeModal();
            }
        });
    }

    // Display results
    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        const resultCountDiv = document.getElementById('resultCount');

        resultCountDiv.textContent = `${data.length}ä»¶ã®ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

        if (data.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            return;
        }

        resultsDiv.innerHTML = '';
        data.forEach(pokemon => {
            const cardFragment = createPokemonCard(pokemon);
            resultsDiv.appendChild(cardFragment);
        });

        // Add click event to show modal
        const cards = resultsDiv.querySelectorAll('.pokemon-card');
        cards.forEach(card => {
            card.addEventListener('click', function(e) {
                const pokemonData = JSON.parse(this.dataset.pokemonData);
                showDetailModal(pokemonData);
            });
        });
    }

    // Event listeners
    // æ¤œç´¢ãƒœã‚¿ãƒ³: æ¤œç´¢å®Ÿè¡Œ + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.getElementById('searchButton').addEventListener('click', () => {
        searchPokemon();
        scrollToResults();
    });

    // Enterã‚­ãƒ¼: æ¤œç´¢å®Ÿè¡Œ + ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.getElementById('searchName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPokemon();
            scrollToResults();
        }
    });

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
            applyQuickFilter();
        });
    });

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('clearSearch', () => {
        // æ¤œç´¢çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
        searchResults = allData;
        // åˆæœŸè¡¨ç¤ºï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰ã‚’è¡¨ç¤º
        displayResults(allData);
    });

    // Load data on page load
    loadData();

    // ä¸€ç•ªä¸Šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã®ã¿ï¼‰
    const scrollToTopBtn = document.getElementById('scrollToTop');

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
    window.addEventListener('scroll', () => {
        if (window.innerWidth <= 768) {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        }
    });

    // ã‚¯ãƒªãƒƒã‚¯ã§ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>
