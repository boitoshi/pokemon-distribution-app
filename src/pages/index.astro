---
import Layout from '../layouts/Layout.astro';
import SearchBox from '../components/SearchBox.astro';
import PokemonCard from '../components/PokemonCard.astro';

const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹">
    <header>
        <div class="header-content">
            <div class="header-left">
                <h1>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
                <p>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢ã§ãã¾ã™</p>
            </div>
            <div class="header-right">
                <button id="toggleDarkMode" class="dark-mode-btn" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>
            </div>
        </div>
    </header>

    <SearchBox />

    <!-- çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div class="dashboard" id="dashboard" style="display: none;">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="dashboard-number" id="totalCount">0</div>
                <div class="dashboard-label">ç·é…å¸ƒæ•°</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="shinyCount">0</div>
                <div class="dashboard-label">è‰²é•ã„</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="activeCount">0</div>
                <div class="dashboard-label">é…ä¿¡ä¸­</div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-number" id="favoriteCount">0</div>
                <div class="dashboard-label">ãŠæ°—ã«å…¥ã‚Š</div>
            </div>
        </div>
        <button id="toggleDashboard" class="toggle-dashboard-btn">ğŸ“Š çµ±è¨ˆã‚’é–‰ã˜ã‚‹</button>
    </div>
    <button id="showDashboard" class="show-dashboard-btn" style="display: none;">ğŸ“Š çµ±è¨ˆã‚’è¡¨ç¤º</button>

    <div class="stats" id="stats" style="display: none;">
        <div class="stats-left">
            <span id="resultCount"></span>
            <div class="stats-actions">
                <button id="exportCsv" class="action-btn" title="CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ“¥ CSV</button>
                <button id="showFavorites" class="action-btn" title="ãŠæ°—ã«å…¥ã‚Šã®ã¿è¡¨ç¤º">â­ ãŠæ°—ã«å…¥ã‚Š</button>
            </div>
        </div>
        <div class="quick-filters" id="quickFilters">
            <button class="quick-filter-btn" data-filter="shiny">
                <span class="quick-icon">âœ¨</span>
                <span class="quick-text">è‰²é•ã„</span>
            </button>
            <button class="quick-filter-btn" data-filter="gigantamax">
                <span class="quick-icon">ğŸ”·</span>
                <span class="quick-text">ã‚­ãƒ§ãƒ€ã‚¤</span>
            </button>
            <button class="quick-filter-btn" data-filter="alpha">
                <span class="quick-icon">ğŸ‘‘</span>
                <span class="quick-text">ã‚ªãƒ¤ãƒ–ãƒ³</span>
            </button>
            <button class="quick-filter-btn" data-filter="moves">
                <span class="quick-icon">ğŸ¯</span>
                <span class="quick-text">æŠ€</span>
            </button>
            <button class="quick-filter-btn" data-filter="item">
                <span class="quick-icon">ğŸ</span>
                <span class="quick-text">æŒã¡ç‰©</span>
            </button>
        </div>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
    <div class="pagination" id="paginationTop" style="display: none;"></div>

    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="results" id="results"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
    <div class="pagination" id="paginationBottom" style="display: none;"></div>

    <!-- ä¸€ç•ªä¸Šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="scrollToTop" class="scroll-to-top" aria-label="ä¸€ç•ªä¸Šã«æˆ»ã‚‹">â†‘</button>

    <PokemonCard />
</Layout>

<script define:vars={{ baseUrl }}>
    let allData = [];
    let currentPage = 1;
    const ITEMS_PER_PAGE = 24;
    const JSON_URL = `${baseUrl.endsWith('/') ? baseUrl : baseUrl + '/'}pokemon.json`;

    // ãŠæ°—ã«å…¥ã‚Šç®¡ç†
    function getFavorites() {
        const stored = localStorage.getItem('pokemon-favorites');
        return stored ? JSON.parse(stored) : [];
    }

    function saveFavorites(favorites) {
        localStorage.setItem('pokemon-favorites', JSON.stringify(favorites));
        updateFavoriteCount();
    }

    function toggleFavorite(managementId) {
        const favorites = getFavorites();
        const index = favorites.indexOf(managementId);
        if (index === -1) {
            favorites.push(managementId);
        } else {
            favorites.splice(index, 1);
        }
        saveFavorites(favorites);
        return index === -1; // true if added
    }

    function isFavorite(managementId) {
        return getFavorites().includes(managementId);
    }

    function updateFavoriteCount() {
        const count = getFavorites().length;
        document.getElementById('favoriteCount').textContent = count;
    }

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
    function initDarkMode() {
        const isDark = localStorage.getItem('dark-mode') === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            document.getElementById('toggleDarkMode').textContent = 'â˜€ï¸';
        }
    }

    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('dark-mode', isDark);
        document.getElementById('toggleDarkMode').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    // ãƒã‚±ãƒ¢ãƒ³ç”»åƒURLç”Ÿæˆé–¢æ•°
    function getPokemonImageUrl(dexNo) {
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${dexNo}.png`;
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    function applyUrlParameters() {
        const params = new URLSearchParams(window.location.search);

        const filters = [
            { param: 'shiny', id: 'filterShiny' },
            { param: 'gigantamax', id: 'filterGigantamax' },
            { param: 'alpha', id: 'filterAlpha' },
            { param: 'moves', id: 'filterSpecialMoves' },
            { param: 'item', id: 'filterHeldItem' },
            { param: 'active', id: 'filterActive' }
        ];

        let hasFilters = false;

        filters.forEach(({ param, id }) => {
            if (params.get(param) === '1') {
                hasFilters = true;
                const el = document.getElementById(id);
                if (el) el.checked = true;
            }
        });

        // åœ°åŸŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const region = params.get('region');
        if (region) {
            hasFilters = true;
            const regionSelect = document.getElementById('filterRegion');
            if (regionSelect) regionSelect.value = region;
        }

        // ãƒªãƒœãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const ribbon = params.get('ribbon');
        if (ribbon) {
            hasFilters = true;
            const ribbonSelect = document.getElementById('filterRibbon');
            if (ribbonSelect) ribbonSelect.value = ribbon;
        }

        // ãƒšãƒ¼ã‚¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const page = params.get('page');
        if (page) {
            currentPage = parseInt(page) || 1;
        }

        if (hasFilters) {
            searchPokemon();
        }
    }

    // Load data on page load
    async function loadData() {
        try {
            const response = await fetch(JSON_URL);
            const data = await response.json();
            allData = data;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'block';

            populateFilters();
            updateDashboard();
            applyUrlParameters();

            const params = new URLSearchParams(window.location.search);
            if (![...params.keys()].some(key => ['shiny', 'gigantamax', 'alpha', 'moves', 'ribbon', 'item', 'region', 'active'].includes(key))) {
                displayResults(allData);
            }
        } catch (error) {
            console.error('Data loading error:', error);
            document.getElementById('loading').innerHTML =
                '<div style="background: white; padding: 30px; border-radius: 8px; color: #d32f2f;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
        }
    }

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
    function updateDashboard() {
        document.getElementById('totalCount').textContent = allData.length;
        document.getElementById('shinyCount').textContent = allData.filter(p => p.shiny && p.shiny !== '').length;
        document.getElementById('activeCount').textContent = allData.filter(p => isDistributionActive(p.endDate)).length;
        updateFavoriteCount();
    }

    // Populate filter dropdowns from data
    function populateFilters() {
        const games = [...new Set(allData.map(p => p.game))].sort();
        const methods = [...new Set(allData.map(p => p.distributionMethod))].sort();

        const gameSelect = document.getElementById('filterGame');
        games.forEach(game => {
            const option = document.createElement('option');
            option.value = game;
            option.textContent = game;
            gameSelect.appendChild(option);
        });

        const methodSelect = document.getElementById('filterMethod');
        methods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            methodSelect.appendChild(option);
        });

        // ãƒªãƒœãƒ³ã®ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
        const ribbonSet = new Set();
        allData.forEach(p => {
            const ribbons = p.ribbons && Array.isArray(p.ribbons)
                ? p.ribbons.filter(r => r && r !== '')
                : [p.ribbon1, p.ribbon2, p.ribbon3].filter(r => r && r !== '');
            ribbons.forEach(r => ribbonSet.add(r));
        });
        const ribbons = [...ribbonSet].sort();

        const ribbonSelect = document.getElementById('filterRibbon');
        ribbons.forEach(ribbon => {
            const option = document.createElement('option');
            option.value = ribbon;
            option.textContent = `ğŸ€ ${ribbon}`;
            ribbonSelect.appendChild(option);
        });
    }

    // æ¤œç´¢çµæœã‚’ä¿å­˜
    let searchResults = [];
    let showingFavorites = false;

    // ã‚½ãƒ¼ãƒˆé–¢æ•°
    function sortData(data, sortOrder) {
        const sorted = [...data];
        switch (sortOrder) {
            case 'date-desc':
                sorted.sort((a, b) => (b.startDate || '').localeCompare(a.startDate || ''));
                break;
            case 'date-asc':
                sorted.sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));
                break;
            case 'dex-asc':
                sorted.sort((a, b) => (a.dexNo || 0) - (b.dexNo || 0));
                break;
            case 'dex-desc':
                sorted.sort((a, b) => (b.dexNo || 0) - (a.dexNo || 0));
                break;
            case 'name-asc':
                sorted.sort((a, b) => (a.pokemonName || '').localeCompare(b.pokemonName || '', 'ja'));
                break;
            case 'name-desc':
                sorted.sort((a, b) => (b.pokemonName || '').localeCompare(a.pokemonName || '', 'ja'));
                break;
        }
        return sorted;
    }

    // Search function
    function searchPokemon() {
        const searchName = document.getElementById('searchName').value.toLowerCase();
        const filterGeneration = document.getElementById('filterGeneration').value;
        const filterGame = document.getElementById('filterGame').value;
        const filterMethod = document.getElementById('filterMethod').value;
        const filterRegion = document.getElementById('filterRegion').value;
        const filterShiny = document.getElementById('filterShiny')?.checked;
        const filterGigantamax = document.getElementById('filterGigantamax')?.checked;
        const filterAlpha = document.getElementById('filterAlpha')?.checked;
        const filterSpecialMoves = document.getElementById('filterSpecialMoves')?.checked;
        const filterHeldItem = document.getElementById('filterHeldItem')?.checked;
        const filterActive = document.getElementById('filterActive')?.checked;
        const filterRibbon = document.getElementById('filterRibbon')?.value;
        const filterDateFrom = document.getElementById('filterDateFrom')?.value;
        const filterDateTo = document.getElementById('filterDateTo')?.value;
        const sortOrder = document.getElementById('sortOrder')?.value || 'date-desc';

        let filtered = allData;

        // Filter by Pokemon name or event name
        if (searchName) {
            filtered = filtered.filter(p =>
                p.pokemonName.toLowerCase().includes(searchName) ||
                p.eventName.toLowerCase().includes(searchName)
            );
        }

        // Filter by generation
        if (filterGeneration) {
            filtered = filtered.filter(p => p.generation === parseInt(filterGeneration));
        }

        // Filter by game
        if (filterGame) {
            filtered = filtered.filter(p => p.game === filterGame);
        }

        // Filter by distribution method
        if (filterMethod) {
            filtered = filtered.filter(p => p.distributionMethod === filterMethod);
        }

        // Filter by region
        if (filterRegion) {
            filtered = filtered.filter(p => p.region === filterRegion);
        }

        // Filter by date range
        if (filterDateFrom) {
            filtered = filtered.filter(p => p.startDate && p.startDate >= filterDateFrom);
        }
        if (filterDateTo) {
            filtered = filtered.filter(p => p.startDate && p.startDate <= filterDateTo);
        }

        // Filter by shiny
        if (filterShiny) {
            filtered = filtered.filter(p => p.shiny && p.shiny !== '');
        }

        // Filter by Gigantamax
        if (filterGigantamax) {
            filtered = filtered.filter(p => p.gigantamax && p.gigantamax !== '');
        }

        // Filter by Alpha
        if (filterAlpha) {
            filtered = filtered.filter(p => p.isAlpha && p.isAlpha !== '');
        }

        // Filter by special moves
        if (filterSpecialMoves) {
            filtered = filtered.filter(p => {
                const moves = p.moves && Array.isArray(p.moves)
                    ? p.moves.filter(m => m && m !== '')
                    : [p.move1, p.move2, p.move3, p.move4].filter(m => m && m !== '');
                return moves.length > 0;
            });
        }

        // Filter by specific ribbon
        if (filterRibbon) {
            filtered = filtered.filter(p => {
                const ribbons = p.ribbons && Array.isArray(p.ribbons)
                    ? p.ribbons.filter(r => r && r !== '')
                    : [p.ribbon1, p.ribbon2, p.ribbon3].filter(r => r && r !== '');
                return ribbons.includes(filterRibbon);
            });
        }

        // Filter by held item
        if (filterHeldItem) {
            filtered = filtered.filter(p => p.heldItem && p.heldItem !== '');
        }

        // Filter by active distribution
        if (filterActive) {
            filtered = filtered.filter(p => isDistributionActive(p.endDate));
        }

        // Apply sort
        filtered = sortData(filtered, sortOrder);

        // Reset to first page
        currentPage = 1;
        showingFavorites = false;
        document.getElementById('showFavorites').classList.remove('active');

        searchResults = filtered;
        resetQuickFilters();
        displayResults(filtered);
    }

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿æ©Ÿèƒ½
    function applyQuickFilter() {
        let filtered = searchResults;

        const activeFilters = [...document.querySelectorAll('.quick-filter-btn.active')]
            .map(btn => btn.dataset.filter);

        activeFilters.forEach(filter => {
            switch(filter) {
                case 'shiny':
                    filtered = filtered.filter(p => p.shiny && p.shiny !== '');
                    break;
                case 'gigantamax':
                    filtered = filtered.filter(p => p.gigantamax && p.gigantamax !== '');
                    break;
                case 'alpha':
                    filtered = filtered.filter(p => p.isAlpha && p.isAlpha !== '');
                    break;
                case 'moves':
                    filtered = filtered.filter(p => {
                        const moves = p.moves && Array.isArray(p.moves)
                            ? p.moves.filter(m => m && m !== '')
                            : [p.move1, p.move2, p.move3, p.move4].filter(m => m && m !== '');
                        return moves.length > 0;
                    });
                    break;
                case 'item':
                    filtered = filtered.filter(p => p.heldItem && p.heldItem !== '');
                    break;
            }
        });

        currentPage = 1;
        displayResults(filtered);
    }

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetQuickFilters() {
        document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    // ãƒ¢ãƒã‚¤ãƒ«ã§çµæœã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    function scrollToResults() {
        if (window.innerWidth <= 768) {
            const resultsEl = document.getElementById('results');
            setTimeout(() => {
                resultsEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    }

    // Check if distribution is active
    function isDistributionActive(endDate) {
        if (!endDate) return true;
        const now = new Date();
        const end = new Date(endDate);
        return now <= end;
    }

    // Create distribution status badge
    function createStatusBadge(endDate) {
        const isActive = isDistributionActive(endDate);
        const statusClass = isActive ? 'status-active' : 'status-ended';
        const statusText = isActive ? 'é…ä¿¡ä¸­' : 'çµ‚äº†';
        return `<span class="status-badge ${statusClass}">${statusText}</span>`;
    }

    // Game type detection helpers
    function isSwSh(game) {
        return game && (game.includes('ã‚½ãƒ¼ãƒ‰') || game.includes('ã‚·ãƒ¼ãƒ«ãƒ‰'));
    }

    function isSV(game) {
        return game && (game.includes('ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ') || game.includes('ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ'));
    }

    function isLegendsGame(game) {
        return game && (game.includes('ã‚¢ãƒ«ã‚»ã‚¦ã‚¹') || game.includes('Z-A'));
    }

    // Create a Pokemon card element
    function createPokemonCard(pokemon) {
        const template = document.getElementById('pokemon-card-template');
        const card = template.content.cloneNode(true);
        const cardEl = card.querySelector('.pokemon-card');

        cardEl.dataset.pokemonData = JSON.stringify(pokemon);
        cardEl.dataset.managementId = pokemon.managementId;

        // ãƒã‚±ãƒ¢ãƒ³ç”»åƒã®è¨­å®š
        const imgEl = cardEl.querySelector('.pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name
        cardEl.querySelector('.pokemon-name').textContent = pokemon.pokemonName;

        // Dex Number
        cardEl.querySelector('.dex-number').textContent = `No.${String(pokemon.dexNo).padStart(3, '0')}`;

        let badgesHtml = '';
        if (pokemon.shiny && pokemon.shiny !== '') {
            badgesHtml += '<span class="icon-badge" title="è‰²é•ã„">âœ¨</span>';
        }
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="icon-badge" title="ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹">ğŸ”·</span>';
        }
        if (pokemon.teraType && pokemon.teraType !== '' && isSV(pokemon.game)) {
            badgesHtml += `<span class="tera-type-badge" title="ãƒ†ãƒ©ã‚¹ã‚¿ã‚¤ãƒ—: ${pokemon.teraType}">${pokemon.teraType}</span>`;
        }
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="icon-badge" title="ã‚ªãƒ¤ãƒ–ãƒ³">ğŸ‘‘</span>';
        }
        cardEl.querySelector('.badges').innerHTML = badgesHtml;

        // Generation badge
        const genBadge = cardEl.querySelector('.generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        cardEl.querySelector('.event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        cardEl.querySelector('.distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        cardEl.querySelector('.distribution-status').innerHTML = createStatusBadge(pokemon.endDate);
        cardEl.querySelector('.distribution-method').textContent = pokemon.distributionMethod;
        cardEl.querySelector('.distribution-location').textContent = pokemon.distributionLocation;

        // Region badge
        if (pokemon.region) {
            const regionRow = cardEl.querySelector('.region-row');
            if (regionRow) {
                regionRow.style.display = 'flex';
                cardEl.querySelector('.region-value').textContent = pokemon.region;
            }
        }

        // Ribbons
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsRow = cardEl.querySelector('.ribbons-row');
            ribbonsRow.style.display = 'flex';
            cardEl.querySelector('.ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        // Favorite button
        const favBtn = cardEl.querySelector('.favorite-btn');
        if (favBtn) {
            favBtn.classList.toggle('active', isFavorite(pokemon.managementId));
            favBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const added = toggleFavorite(pokemon.managementId);
                favBtn.classList.toggle('active', added);
            });
        }

        return card;
    }

    // Show modal with Pokemon details
    function showDetailModal(pokemon) {
        const template = document.getElementById('pokemon-modal-template');
        const modal = template.content.cloneNode(true);
        const modalEl = modal.querySelector('.modal-overlay');

        // Pokemon image
        const imgEl = modalEl.querySelector('.modal-pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name with shiny indicator
        const pokemonNameEl = modalEl.querySelector('.modal-pokemon-name');
        pokemonNameEl.textContent = pokemon.pokemonName;
        if (pokemon.shiny && pokemon.shiny !== '') {
            pokemonNameEl.innerHTML = pokemon.pokemonName + ' <span class="modal-shiny-indicator" title="è‰²é•ã„">âœ¨</span>';
        }

        // Dex Number
        modalEl.querySelector('.modal-dex-number').textContent = `No.${String(pokemon.dexNo).padStart(3, '0')}`;

        // Badges
        let badgesHtml = '';
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="icon-badge mobile-only" title="ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹">ğŸ”·</span>';
            badgesHtml += '<span class="text-badge pc-only">ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹å¯</span>';
        }
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="icon-badge mobile-only" title="ã‚ªãƒ¤ãƒ–ãƒ³">ğŸ‘‘</span>';
            badgesHtml += '<span class="text-badge pc-only">ã‚ªãƒ¤ãƒ–ãƒ³</span>';
        }
        modalEl.querySelector('.modal-badges').innerHTML = badgesHtml;

        // Generation badge
        const genBadge = modalEl.querySelector('.modal-generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        modalEl.querySelector('.modal-event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        modalEl.querySelector('.modal-distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        modalEl.querySelector('.modal-distribution-status').innerHTML = createStatusBadge(pokemon.endDate);
        modalEl.querySelector('.modal-distribution-method').textContent = pokemon.distributionMethod;
        modalEl.querySelector('.modal-distribution-location').textContent = pokemon.distributionLocation;
        modalEl.querySelector('.modal-game').textContent = pokemon.game;

        // Region
        if (pokemon.region) {
            const regionRow = modalEl.querySelector('.modal-region-row');
            if (regionRow) {
                regionRow.style.display = 'flex';
                modalEl.querySelector('.modal-region').textContent = pokemon.region;
            }
        }

        // Stats
        modalEl.querySelector('.modal-level').textContent = pokemon.level || '?';
        modalEl.querySelector('.modal-ability').textContent = pokemon.ability || '?';

        if (pokemon.nature) {
            const natureRow = modalEl.querySelector('.modal-nature-row');
            natureRow.style.display = 'flex';
            modalEl.querySelector('.modal-nature').textContent = pokemon.nature;
        }

        // Ball info
        const ballStatus = modalEl.querySelector('.modal-ball-status');
        if (pokemon.ball) {
            ballStatus.innerHTML = `âšª ${pokemon.ball}`;
        } else {
            ballStatus.textContent = '?';
        }

        // Tera Type
        if (pokemon.teraType && pokemon.teraType !== '' && isSV(pokemon.game)) {
            const teraTypeRow = modalEl.querySelector('.modal-tera-type-row');
            teraTypeRow.style.display = 'flex';
            modalEl.querySelector('.modal-tera-type').textContent = pokemon.teraType;
        }

        // Held item
        if (pokemon.heldItem && pokemon.heldItem !== '') {
            const itemRow = modalEl.querySelector('.modal-item-row');
            itemRow.style.display = 'flex';
            modalEl.querySelector('.modal-item-tag').textContent = pokemon.heldItem;
        }

        // Moves
        const moves = pokemon.moves && Array.isArray(pokemon.moves)
            ? pokemon.moves.filter(m => m && m !== '')
            : [pokemon.move1, pokemon.move2, pokemon.move3, pokemon.move4].filter(m => m && m !== '');
        if (moves.length > 0) {
            const movesSection = modalEl.querySelector('.modal-moves-section');
            movesSection.style.display = 'block';
            modalEl.querySelector('.modal-moves').innerHTML = moves.map(move =>
                `<div class="move-item">${move}</div>`
            ).join('');
        }

        // Trainer info - OT
        const otEl = modalEl.querySelector('.modal-ot');
        if (pokemon.ot) {
            if (typeof pokemon.ot === 'object') {
                const otParts = [];
                if (pokemon.ot.ja) otParts.push(`æ—¥: ${pokemon.ot.ja}`);
                if (pokemon.ot.en) otParts.push(`è‹±: ${pokemon.ot.en}`);
                if (pokemon.ot.ko) otParts.push(`éŸ“: ${pokemon.ot.ko}`);
                if (pokemon.ot.zh) otParts.push(`ä¸­: ${pokemon.ot.zh}`);
                otEl.textContent = otParts.join(' / ') || '?';
            } else {
                otEl.textContent = pokemon.ot;
            }
        } else {
            otEl.textContent = '?';
        }

        if (pokemon.trainerId) {
            const trainerIdRow = modalEl.querySelector('.modal-trainer-id-row');
            trainerIdRow.style.display = 'flex';
            modalEl.querySelector('.modal-trainer-id').textContent = pokemon.trainerId;
        }

        // Ribbons
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsSection = modalEl.querySelector('.modal-ribbons-section');
            ribbonsSection.style.display = 'block';
            modalEl.querySelector('.modal-ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        // Notes
        if (pokemon.notes && pokemon.notes !== '') {
            const notesSection = modalEl.querySelector('.modal-notes-section');
            notesSection.style.display = 'block';
            modalEl.querySelector('.modal-notes').textContent = pokemon.notes;
        }

        // Post URL
        if (pokemon.postUrl && pokemon.postUrl !== '') {
            const postUrlRow = modalEl.querySelector('.modal-post-url-row');
            postUrlRow.style.display = 'flex';
            const postUrlLink = modalEl.querySelector('.modal-post-url-link');
            postUrlLink.href = pokemon.postUrl;
        }

        // Share buttons
        const shareSection = modalEl.querySelector('.modal-share-section');
        if (shareSection) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?id=${pokemon.managementId}`;
            const shareText = `${pokemon.pokemonName} - ${pokemon.eventName}`;

            const twitterBtn = shareSection.querySelector('.share-twitter');
            if (twitterBtn) {
                twitterBtn.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
            }

            const copyBtn = shareSection.querySelector('.share-copy');
            if (copyBtn) {
                copyBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                        setTimeout(() => {
                            copyBtn.textContent = 'ğŸ”— URLã‚³ãƒ”ãƒ¼';
                        }, 2000);
                    });
                });
            }
        }

        // Favorite button in modal
        const modalFavBtn = modalEl.querySelector('.modal-favorite-btn');
        if (modalFavBtn) {
            modalFavBtn.classList.toggle('active', isFavorite(pokemon.managementId));
            modalFavBtn.addEventListener('click', () => {
                const added = toggleFavorite(pokemon.managementId);
                modalFavBtn.classList.toggle('active', added);
                modalFavBtn.textContent = added ? 'â­ ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'â˜† ãŠæ°—ã«å…¥ã‚Šç™»éŒ²';
                // Update card button too
                const card = document.querySelector(`[data-management-id="${pokemon.managementId}"] .favorite-btn`);
                if (card) card.classList.toggle('active', added);
            });
            modalFavBtn.textContent = isFavorite(pokemon.managementId) ? 'â­ ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'â˜† ãŠæ°—ã«å…¥ã‚Šç™»éŒ²';
        }

        document.body.appendChild(modal);

        const overlay = document.querySelector('.modal-overlay');
        const closeBtn = overlay.querySelector('.modal-close');
        const bottomCloseBtn = overlay.querySelector('.modal-bottom-close');

        const closeModal = () => {
            overlay.remove();
        };

        closeBtn.addEventListener('click', closeModal);
        bottomCloseBtn.addEventListener('click', closeModal);

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeModal();
            }
        });

        // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
    function createPagination(totalItems, currentPage) {
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        if (totalPages <= 1) return '';

        let html = '<div class="pagination-inner">';

        // å‰ã¸
        if (currentPage > 1) {
            html += `<button class="page-btn" data-page="${currentPage - 1}">Â« å‰</button>`;
        }

        // ãƒšãƒ¼ã‚¸ç•ªå·
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<button class="page-btn" data-page="1">1</button>`;
            if (startPage > 2) html += '<span class="page-dots">...</span>';
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += '<span class="page-dots">...</span>';
            html += `<button class="page-btn" data-page="${totalPages}">${totalPages}</button>`;
        }

        // æ¬¡ã¸
        if (currentPage < totalPages) {
            html += `<button class="page-btn" data-page="${currentPage + 1}">æ¬¡ Â»</button>`;
        }

        html += '</div>';
        html += `<div class="page-info">${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ (${totalItems}ä»¶)</div>`;

        return html;
    }

    // Display results with pagination
    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        const resultCountDiv = document.getElementById('resultCount');
        const paginationTop = document.getElementById('paginationTop');
        const paginationBottom = document.getElementById('paginationBottom');

        const totalItems = data.length;
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, totalItems);
        const pageData = data.slice(startIndex, endIndex);

        resultCountDiv.textContent = `${totalItems}ä»¶ã®ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

        if (totalItems === 0) {
            resultsDiv.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            paginationTop.style.display = 'none';
            paginationBottom.style.display = 'none';
            return;
        }

        // Pagination
        const paginationHtml = createPagination(totalItems, currentPage);
        paginationTop.innerHTML = paginationHtml;
        paginationBottom.innerHTML = paginationHtml;
        paginationTop.style.display = totalPages > 1 ? 'block' : 'none';
        paginationBottom.style.display = totalPages > 1 ? 'block' : 'none';

        // Add pagination event listeners
        document.querySelectorAll('.page-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentPage = parseInt(btn.dataset.page);
                displayResults(data);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });

        resultsDiv.innerHTML = '';
        pageData.forEach(pokemon => {
            const cardFragment = createPokemonCard(pokemon);
            resultsDiv.appendChild(cardFragment);
        });

        // Add click event to show modal
        const cards = resultsDiv.querySelectorAll('.pokemon-card');
        cards.forEach(card => {
            card.addEventListener('click', function(e) {
                // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
                if (e.target.closest('.favorite-btn')) return;
                const pokemonData = JSON.parse(this.dataset.pokemonData);
                showDetailModal(pokemonData);
            });
        });
    }

    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportToCsv(data) {
        const headers = ['ç®¡ç†ID', 'ãƒã‚±ãƒ¢ãƒ³å', 'å›³é‘‘No', 'ä¸–ä»£', 'ã‚²ãƒ¼ãƒ ', 'åœ°åŸŸ', 'ã‚¤ãƒ™ãƒ³ãƒˆå', 'é…ä¿¡æ–¹æ³•', 'é…ä¿¡å ´æ‰€', 'é–‹å§‹æ—¥', 'çµ‚äº†æ—¥', 'è‰²é•ã„', 'ãƒ¬ãƒ™ãƒ«', 'ç‰¹æ€§', 'æ€§æ ¼', 'ãƒœãƒ¼ãƒ«', 'æŒã¡ç‰©', 'æŠ€', 'ãƒªãƒœãƒ³', 'è¦ªå', 'ID', 'å‚™è€ƒ'];

        const rows = data.map(p => {
            const moves = p.moves && Array.isArray(p.moves) ? p.moves.join('/') : [p.move1, p.move2, p.move3, p.move4].filter(m => m).join('/');
            const ribbons = p.ribbons && Array.isArray(p.ribbons) ? p.ribbons.join('/') : [p.ribbon1, p.ribbon2, p.ribbon3].filter(r => r).join('/');
            const ot = typeof p.ot === 'object' ? Object.values(p.ot).join('/') : p.ot;

            return [
                p.managementId || '',
                p.pokemonName || '',
                p.dexNo || '',
                p.generation || '',
                p.game || '',
                p.region || '',
                p.eventName || '',
                p.distributionMethod || '',
                p.distributionLocation || '',
                p.startDate || '',
                p.endDate || '',
                p.shiny || '',
                p.level || '',
                p.ability || '',
                p.nature || '',
                p.ball || '',
                p.heldItem || '',
                moves,
                ribbons,
                ot || '',
                p.trainerId || '',
                p.notes || ''
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
        });

        const csv = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pokemon-distribution-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Event listeners
    document.getElementById('searchButton').addEventListener('click', () => {
        searchPokemon();
        scrollToResults();
    });

    document.getElementById('searchName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPokemon();
            scrollToResults();
        }
    });

    // ã‚½ãƒ¼ãƒˆå¤‰æ›´æ™‚ã«å†æ¤œç´¢
    document.getElementById('sortOrder').addEventListener('change', () => {
        searchPokemon();
    });

    // ç´ æ—©ã„çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.classList.toggle('active');
            applyQuickFilter();
        });
    });

    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    document.getElementById('exportCsv').addEventListener('click', () => {
        exportToCsv(searchResults.length > 0 ? searchResults : allData);
    });

    // ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤º
    document.getElementById('showFavorites').addEventListener('click', function() {
        showingFavorites = !showingFavorites;
        this.classList.toggle('active', showingFavorites);

        if (showingFavorites) {
            const favorites = getFavorites();
            const favoriteData = allData.filter(p => favorites.includes(p.managementId));
            currentPage = 1;
            displayResults(favoriteData);
        } else {
            displayResults(searchResults.length > 0 ? searchResults : allData);
        }
    });

    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('toggleDashboard').addEventListener('click', () => {
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('showDashboard').style.display = 'block';
    });

    document.getElementById('showDashboard').addEventListener('click', () => {
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('showDashboard').style.display = 'none';
    });

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    document.getElementById('toggleDarkMode').addEventListener('click', toggleDarkMode);

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('clearSearch', () => {
        searchResults = allData;
        showingFavorites = false;
        currentPage = 1;
        document.getElementById('showFavorites').classList.remove('active');
        displayResults(allData);
    });

    // åˆæœŸåŒ–
    initDarkMode();
    loadData();

    // ä¸€ç•ªä¸Šã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
    const scrollToTopBtn = document.getElementById('scrollToTop');

    window.addEventListener('scroll', () => {
        if (window.innerWidth <= 768) {
            if (window.scrollY > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        }
    });

    scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>
