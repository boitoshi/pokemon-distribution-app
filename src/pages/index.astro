---
import Layout from '../layouts/Layout.astro';
import SearchBox from '../components/SearchBox.astro';
import PokemonCard from '../components/PokemonCard.astro';

const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹">
    <header>
        <h1>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³æ¤œç´¢ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h1>
        <p>é…ä¿¡ãƒã‚±ãƒ¢ãƒ³ã‚’æ¤œç´¢ã§ãã¾ã™</p>
    </header>

    <SearchBox />

    <div class="stats" id="stats" style="display: none;">
        <span id="resultCount"></span>
        <span id="lastUpdated"></span>
    </div>

    <div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="results" id="results"></div>

    <PokemonCard />
</Layout>

<script define:vars={{ baseUrl }}>
    let allData = [];
    const JSON_URL = `${baseUrl.endsWith('/') ? baseUrl : baseUrl + '/'}pokemon.json`;

    // ãƒã‚±ãƒ¢ãƒ³ç”»åƒURLç”Ÿæˆé–¢æ•°ï¼ˆå°†æ¥çš„ã«è‡ªå‰ç”»åƒã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼‰
    function getPokemonImageUrl(dexNo) {
        // æ¤œè¨¼ç”¨: PokeAPIå…¬å¼ã‚¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯
        return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${dexNo}.png`;

        // æœ¬ç•ªç”¨ï¼ˆè‡ªå‰ç”»åƒã‚’ä½¿ã†å ´åˆã¯ã“ã¡ã‚‰ã«åˆ‡ã‚Šæ›¿ãˆï¼‰:
        // return `${baseUrl}images/pokemon/${dexNo}.png`;
    }

    // Load data on page load
    async function loadData() {
        try {
            const response = await fetch(JSON_URL);
            const data = await response.json();
            allData = data;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('stats').style.display = 'flex';

            // Populate filter dropdowns
            populateFilters();

            // Display all results
            displayResults(allData);
        } catch (error) {
            console.error('Data loading error:', error);
            document.getElementById('loading').innerHTML =
                '<div style="background: white; padding: 30px; border-radius: 8px; color: #d32f2f;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
        }
    }

    // Populate filter dropdowns from data
    function populateFilters() {
        const games = [...new Set(allData.map(p => p.game))].sort();
        const methods = [...new Set(allData.map(p => p.distributionMethod))].sort();

        const gameSelect = document.getElementById('filterGame');
        games.forEach(game => {
            const option = document.createElement('option');
            option.value = game;
            option.textContent = game;
            gameSelect.appendChild(option);
        });

        const methodSelect = document.getElementById('filterMethod');
        methods.forEach(method => {
            const option = document.createElement('option');
            option.value = method;
            option.textContent = method;
            methodSelect.appendChild(option);
        });
    }

    // Search function
    function searchPokemon() {
        const searchName = document.getElementById('searchName').value.toLowerCase();
        const filterGeneration = document.getElementById('filterGeneration').value;
        const filterGame = document.getElementById('filterGame').value;
        const filterMethod = document.getElementById('filterMethod').value;
        const filterShiny = document.getElementById('filterShiny').checked;
        const filterGigantamax = document.getElementById('filterGigantamax').checked;
        const filterTera = document.getElementById('filterTera').checked;
        const filterAlpha = document.getElementById('filterAlpha').checked;

        let filtered = allData;

        // Filter by Pokemon name or event name
        if (searchName) {
            filtered = filtered.filter(p =>
                p.pokemonName.toLowerCase().includes(searchName) ||
                p.eventName.toLowerCase().includes(searchName)
            );
        }

        // Filter by generation
        if (filterGeneration) {
            filtered = filtered.filter(p => p.generation === parseInt(filterGeneration));
        }

        // Filter by game
        if (filterGame) {
            filtered = filtered.filter(p => p.game === filterGame);
        }

        // Filter by distribution method
        if (filterMethod) {
            filtered = filtered.filter(p => p.distributionMethod === filterMethod);
        }

        // Filter by shiny
        if (filterShiny) {
            filtered = filtered.filter(p => p.shiny && p.shiny !== '');
        }

        // Filter by Gigantamax
        if (filterGigantamax) {
            filtered = filtered.filter(p => p.gigantamax && p.gigantamax !== '');
        }

        // Filter by Tera type
        if (filterTera) {
            filtered = filtered.filter(p => p.teraType && p.teraType !== '');
        }

        // Filter by Alpha (ã‚ªãƒ¤ãƒ–ãƒ³)
        if (filterAlpha) {
            filtered = filtered.filter(p => p.isAlpha && p.isAlpha !== '');
        }

        displayResults(filtered);
    }

    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
    }

    // Game type detection helpers
    function isSwSh(game) {
        return game && (game.includes('ã‚½ãƒ¼ãƒ‰') || game.includes('ã‚·ãƒ¼ãƒ«ãƒ‰'));
    }

    function isSV(game) {
        return game && (game.includes('ã‚¹ã‚«ãƒ¼ãƒ¬ãƒƒãƒˆ') || game.includes('ãƒã‚¤ã‚ªãƒ¬ãƒƒãƒˆ'));
    }

    function isLegendsGame(game) {
        return game && (game.includes('ã‚¢ãƒ«ã‚»ã‚¦ã‚¹') || game.includes('Z-A'));
    }

    // Create a Pokemon card element
    function createPokemonCard(pokemon) {
        const template = document.getElementById('pokemon-card-template');
        const card = template.content.cloneNode(true);
        const cardEl = card.querySelector('.pokemon-card');

        // Store pokemon data for modal
        cardEl.dataset.pokemonData = JSON.stringify(pokemon);

        // ãƒã‚±ãƒ¢ãƒ³ç”»åƒã®è¨­å®š
        const imgEl = cardEl.querySelector('.pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†ï¼ˆç”»åƒã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼‰
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name
        cardEl.querySelector('.pokemon-name').textContent = pokemon.pokemonName;

        let badgesHtml = '';
        if (pokemon.shiny && pokemon.shiny !== '') {
            badgesHtml += '<span class="shiny-badge">è‰²é•ã„</span>';
        }
        // ã‚­ãƒ§ãƒ€ã‚¤ãƒãƒƒã‚¯ã‚¹ï¼ˆã‚½ãƒ¼ãƒ‰/ã‚·ãƒ¼ãƒ«ãƒ‰ã®ã¿ï¼‰
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="gigantamax-badge">ã‚­ãƒ§ãƒ€ã‚¤</span>';
        }
        // ã‚ªãƒ¤ãƒ–ãƒ³ï¼ˆã‚¢ãƒ«ã‚»ã‚¦ã‚¹/Z-Aã®ã¿ï¼‰
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="alpha-badge">ã‚ªãƒ¤ãƒ–ãƒ³</span>';
        }
        cardEl.querySelector('.badges').innerHTML = badgesHtml;

        // Pokemon ID
        cardEl.querySelector('.pokemon-id').textContent = `#${String(pokemon.dexNo).padStart(4, '0')}`;

        // Generation badge
        const genBadge = cardEl.querySelector('.generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        cardEl.querySelector('.event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        cardEl.querySelector('.distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        // Distribution method and location
        cardEl.querySelector('.distribution-method').textContent = pokemon.distributionMethod;
        cardEl.querySelector('.distribution-location').textContent = pokemon.distributionLocation;

        // Ribbons (é…åˆ—å½¢å¼ã¾ãŸã¯ã‚«ãƒ©ãƒ å½¢å¼ã«å¯¾å¿œ)
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsRow = cardEl.querySelector('.ribbons-row');
            ribbonsRow.style.display = 'flex';
            cardEl.querySelector('.ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        return card;
    }

    // Show modal with Pokemon details
    function showDetailModal(pokemon) {
        const template = document.getElementById('pokemon-modal-template');
        const modal = template.content.cloneNode(true);
        const modalEl = modal.querySelector('.modal-overlay');

        // Pokemon image
        const imgEl = modalEl.querySelector('.modal-pokemon-image');
        imgEl.src = getPokemonImageUrl(pokemon.dexNo);
        imgEl.alt = pokemon.pokemonName;
        imgEl.addEventListener('error', function() {
            this.style.display = 'none';
        });

        // Name and shiny indicator
        modalEl.querySelector('.modal-pokemon-name').textContent = pokemon.pokemonName;

        // Shiny indicator next to name
        const shinyIndicator = modalEl.querySelector('.modal-shiny-indicator');
        if (pokemon.shiny && pokemon.shiny !== '') {
            shinyIndicator.textContent = 'âœ¨';
            shinyIndicator.title = 'è‰²é•ã„';
        }

        // Badges (excluding shiny, which is now next to name)
        let badgesHtml = '';
        if (pokemon.gigantamax && pokemon.gigantamax !== '' && isSwSh(pokemon.game)) {
            badgesHtml += '<span class="gigantamax-badge">ã‚­ãƒ§ãƒ€ã‚¤</span>';
        }
        if (pokemon.isAlpha && pokemon.isAlpha !== '' && isLegendsGame(pokemon.game)) {
            badgesHtml += '<span class="alpha-badge">ã‚ªãƒ¤ãƒ–ãƒ³</span>';
        }
        modalEl.querySelector('.modal-badges').innerHTML = badgesHtml;

        // Pokemon ID
        modalEl.querySelector('.modal-pokemon-id').textContent = `#${String(pokemon.dexNo).padStart(4, '0')}`;

        // Generation badge
        const genBadge = modalEl.querySelector('.modal-generation-badge');
        genBadge.textContent = `ç¬¬${pokemon.generation}ä¸–ä»£`;
        genBadge.classList.add(`gen-${pokemon.generation}`);

        // Basic info
        modalEl.querySelector('.modal-event-name').textContent = pokemon.eventName;

        const startDate = formatDate(pokemon.startDate);
        const endDate = pokemon.endDate ? formatDate(pokemon.endDate) : 'çµ‚äº†æ—¥æœªå®š';
        modalEl.querySelector('.modal-distribution-period').textContent = `${startDate} ã€œ ${endDate}`;

        modalEl.querySelector('.modal-distribution-method').textContent = pokemon.distributionMethod;
        modalEl.querySelector('.modal-distribution-location').textContent = pokemon.distributionLocation;
        modalEl.querySelector('.modal-game').textContent = pokemon.game;

        // Stats
        modalEl.querySelector('.modal-level').textContent = pokemon.level || '?';
        modalEl.querySelector('.modal-ability').textContent = pokemon.ability || '?';

        if (pokemon.nature) {
            const natureRow = modalEl.querySelector('.modal-nature-row');
            natureRow.style.display = 'flex';
            modalEl.querySelector('.modal-nature').textContent = pokemon.nature;
        }

        // Ball info (with icon)
        const ballStatus = modalEl.querySelector('.modal-ball-status');
        if (pokemon.ball) {
            ballStatus.innerHTML = `âšª ${pokemon.ball}`;
        } else {
            ballStatus.textContent = '?';
        }

        // Tera type (SV only)
        if (pokemon.teraType && pokemon.teraType !== '' && isSV(pokemon.game)) {
            const teraRow = modalEl.querySelector('.modal-tera-row');
            teraRow.style.display = 'flex';
            const teraBadge = modalEl.querySelector('.modal-tera-type-badge');
            teraBadge.textContent = pokemon.teraType;
            teraBadge.classList.add(`type-${pokemon.teraType}`);
        }

        // Held item (optional)
        if (pokemon.heldItem && pokemon.heldItem !== '') {
            const itemRow = modalEl.querySelector('.modal-item-row');
            itemRow.style.display = 'flex';
            modalEl.querySelector('.modal-item-tag').textContent = pokemon.heldItem;
        }

        // Moves (displayed as vertical list)
        const moves = pokemon.moves && Array.isArray(pokemon.moves)
            ? pokemon.moves.filter(m => m && m !== '')
            : [pokemon.move1, pokemon.move2, pokemon.move3, pokemon.move4].filter(m => m && m !== '');
        if (moves.length > 0) {
            const movesSection = modalEl.querySelector('.modal-moves-section');
            movesSection.style.display = 'block';
            modalEl.querySelector('.modal-moves').innerHTML = moves.map(move =>
                `<div class="move-item">${move}</div>`
            ).join('');
        }

        // Trainer info - OT with multi-language support
        const otEl = modalEl.querySelector('.modal-ot');
        if (pokemon.ot) {
            if (typeof pokemon.ot === 'object') {
                // Multi-language OT object (e.g., {ja: "ã‚µãƒˆã‚·", en: "Ash"})
                const otParts = [];
                if (pokemon.ot.ja) otParts.push(`æ—¥: ${pokemon.ot.ja}`);
                if (pokemon.ot.en) otParts.push(`è‹±: ${pokemon.ot.en}`);
                if (pokemon.ot.ko) otParts.push(`éŸ“: ${pokemon.ot.ko}`);
                if (pokemon.ot.zh) otParts.push(`ä¸­: ${pokemon.ot.zh}`);
                otEl.textContent = otParts.join(' / ') || '?';
            } else {
                // String OT
                otEl.textContent = pokemon.ot;
            }
        } else {
            otEl.textContent = '?';
        }

        if (pokemon.trainerId) {
            const trainerIdRow = modalEl.querySelector('.modal-trainer-id-row');
            trainerIdRow.style.display = 'flex';
            modalEl.querySelector('.modal-trainer-id').textContent = pokemon.trainerId;
        }

        // Ribbons
        const ribbons = pokemon.ribbons && Array.isArray(pokemon.ribbons)
            ? pokemon.ribbons.filter(r => r && r !== '')
            : [pokemon.ribbon1, pokemon.ribbon2, pokemon.ribbon3].filter(r => r && r !== '');
        if (ribbons.length > 0) {
            const ribbonsSection = modalEl.querySelector('.modal-ribbons-section');
            ribbonsSection.style.display = 'block';
            modalEl.querySelector('.modal-ribbons').innerHTML = ribbons.map(ribbon =>
                `<span class="ribbon-icon">ğŸ€ ${ribbon}</span>`
            ).join('');
        }

        // Notes
        if (pokemon.notes && pokemon.notes !== '') {
            const notesSection = modalEl.querySelector('.modal-notes-section');
            notesSection.style.display = 'block';
            modalEl.querySelector('.modal-notes').textContent = pokemon.notes;
        }

        // Post URL
        if (pokemon.postUrl && pokemon.postUrl !== '') {
            const postUrlRow = modalEl.querySelector('.modal-post-url-row');
            postUrlRow.style.display = 'flex';
            const postUrlLink = modalEl.querySelector('.modal-post-url-link');
            postUrlLink.href = pokemon.postUrl;
        }

        // Add to body
        document.body.appendChild(modal);

        // Close modal on overlay click or close button
        const overlay = document.querySelector('.modal-overlay');
        const closeBtn = overlay.querySelector('.modal-close');

        closeBtn.addEventListener('click', () => {
            overlay.remove();
        });

        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        });
    }

    // Display results
    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        const resultCountDiv = document.getElementById('resultCount');

        resultCountDiv.textContent = `${data.length}ä»¶ã®ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

        if (data.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹ãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            return;
        }

        resultsDiv.innerHTML = '';
        data.forEach(pokemon => {
            const cardFragment = createPokemonCard(pokemon);
            resultsDiv.appendChild(cardFragment);
        });

        // Add click event to show modal
        const cards = resultsDiv.querySelectorAll('.pokemon-card');
        cards.forEach(card => {
            card.addEventListener('click', function(e) {
                const pokemonData = JSON.parse(this.dataset.pokemonData);
                showDetailModal(pokemonData);
            });
        });
    }

    // Event listeners
    document.getElementById('searchButton').addEventListener('click', searchPokemon);
    document.getElementById('searchName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPokemon();
        }
    });
    document.getElementById('filterShiny').addEventListener('change', searchPokemon);
    document.getElementById('filterGigantamax').addEventListener('change', searchPokemon);
    document.getElementById('filterTera').addEventListener('change', searchPokemon);
    document.getElementById('filterAlpha').addEventListener('change', searchPokemon);

    // Load data on page load
    loadData();
</script>
